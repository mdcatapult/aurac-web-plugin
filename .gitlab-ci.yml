# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
stages:
  - test-lint-build
  - release
  - test
variables:
  GIT_SUBMODULE_STRATEGY: recursive
test-lint-build:
  stage: test-lint-build
  image: registry.mdcatapult.io/informatics/docker-images/ci/node
  tags:
    - wopr
  artifacts:
    paths:
      - dist/*
  before_script:
    - apt-get -yqq update && apt-get upgrade -yqq chromium libxss1 xvfb
    - export CHROME_BIN=/usr/bin/chromium
    - npm install
    - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.36.0/install.sh | bash
    - ". ~/.nvm/nvm.sh"
    - nvm install 16.10
    - nvm use 16.10
    - npx browserslist --update-db
    
  script:
    - npm run test:ci
    - npm run lint
    - npm run build
    - npm run mocha
    - npm run package
  coverage: /Lines\s+:\s(\d+\.?\d*)%\s\(\s\d+\/\d+\s\)/
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

release:
  stage: release
  image: registry.mdcatapult.io/informatics/docker-images/ci/node
  tags:
    - wopr
  script:
    - /scripts/release.sh -b -r develop -u 'dist/browser-plugin/web-ext-artifacts/aurac-*.zip'
  only:
    - master
  except:
    variables:
      - '$CI_COMMIT_MESSAGE =~ /^Setting version to.*/'
sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml
